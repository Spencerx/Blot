# app/models/template

This module is the persistence and business-logic layer for Blot's template system. It manages the full lifecycle of templates and their constituent views: creation, retrieval, update, deletion, file-system synchronization, sharing, CDN manifest management, and partial resolution at render time.

Templates are the theming unit of a Blot blog. Each template is owned either by a specific blog (identified by `blogID`) or by the string `"SITE"`, which designates a platform-level template that any blog may use but no blog may edit. A template contains one or more **views** (named Mustache files), each of which may be mapped to one or more URL patterns that determine which view is rendered for a given request.

All state is stored in Redis. There is no relational database or document store involved.

---

## File Inventory

### Root-level files

| File | Description |
|------|-------------|
| `index.js` | Public interface. Re-exports all functions and constants described below. |
| `key.js` | Generates all Redis key strings used by this module. |
| `metadataModel.js` | Schema definition for a template's metadata record (field names to type strings). |
| `viewModel.js` | Schema definition for a single view record. |
| `create.js` | Creates a new template record in Redis for a given owner. |
| `update.js` | Updates template metadata and manages the public-template set membership. |
| `drop.js` | Deletes a template and all associated views, URL mappings, CDN records, and disk-cached rendered output. |
| `clone.js` | Copies all views and metadata from one template ID to another. Used internally by `create` when `metadata.cloneFrom` is set. |
| `getMetadata.js` | Retrieves a template's metadata hash from Redis by template ID. |
| `setMetadata.js` | Writes metadata updates to Redis, manages public-template set membership, bumps the blog's `cacheID`, and triggers CDN manifest regeneration. |
| `getView.js` | Retrieves a single view by name or by extension-less name (e.g. `"head"` resolves to `"head.html"`). |
| `setView.js` | Writes a view to Redis. Validates Mustache syntax, enforces a 2 MB payload limit, normalizes URL patterns, detects infinite partial-dependency cycles, and triggers CDN manifest regeneration. |
| `dropView.js` | Removes a single view from Redis along with its URL mapping, URL pattern entry, and allViews set membership. |
| `getAllViews.js` | Returns all views for a template as an object keyed by view name, together with the template metadata. |
| `getMultipleViews.js` | Fetches a set of views in parallel by name list. Individual missing views are silently skipped. |
| `setMultipleViews.js` | Writes multiple views in parallel. Used by `clone`. |
| `getFullView.js` | Returns a view's content, resolved partials, aggregated retrieve descriptors, MIME type, and locals — the complete rendering payload for a single view. |
| `getPartials.js` | Recursively resolves a view's partial tree. Partials whose name starts with `/` are fetched as entry HTML from `models/entry`; others are fetched as template views. |
| `getViewByURL.js` | Matches a URL against stored URL patterns (using `path-to-regexp`) and falls back to exact URL lookup. Returns the matching view name, path params, and query string. |
| `getTemplateList.js` | Returns the combined list of SITE-owned templates and blog-owned templates visible to a given blog. |
| `parseTemplate.js` | Parses Mustache template content and returns two objects: `partials` (partial names referenced in the template) and `retrieve` (a descriptor of which data locals must be fetched before rendering, including CDN targets). |
| `injectLocals.js` | Mutates a template's `locals` object in-place to hydrate font and syntax-highlighter entries with canonical data from the platform's static font and theme registries. Called whenever metadata is saved. |
| `isOwner.js` | Checks whether a given blog ID is a member of a template's owning-blog set in Redis. |
| `buildFromFolder.js` | Scans a blog's `templates/` or `Templates/` directory and calls `readFromFolder` for each subdirectory. Removes locally-edited templates that no longer exist on disk. |
| `readFromFolder.js` | Reads a single template directory from disk: creates the template if it does not exist, parses `package.json`, drops deleted views, and saves each file as a view via `setView`. |
| `writeToFolder.js` | Writes a template's views and generated `package.json` back to the blog's file-system folder. Removes orphaned files that are no longer in the template. Requires ownership. |
| `removeFromFolder.js` | Removes a locally-edited template's folder from the blog's file system. Only acts when `metadata.localEditing` is true. |
| `removeEnabledFromAllTemplates.js` | Iterates all template folders in a blog's directory and sets `enabled: false` in each `package.json`, then writes updated metadata back to locally-edited templates. Used when a different template is activated. |
| `determineTemplateFolder.js` | Inspects the root of a blog's local directory and returns either `"Templates"` or `"templates"`, preferring whichever already exists. |
| `package.js` | Serializes template metadata and view metadata to/from the `package.json` format used in locally-edited templates. Exports `generate` (produces JSON string) and `save` (applies parsed package data to Redis via `setMetadata`). |
| `createShareID.js` | Generates a UUID share token for a template and stores it in Redis. |
| `dropShareID.js` | Removes a share token from the template's metadata and from Redis. |
| `getByShareID.js` | Looks up a template by its share token and returns the full metadata. |

### `util/` subdirectory

| File | Description |
|------|-------------|
| `util/makeID.js` | Derives a stable template ID from an owner string and a name by slugifying the name and joining with `":"`. Example: `"abc123:my-theme"`. |
| `util/serialize.js` | Converts `object` and `array` typed fields in a model instance to JSON strings before writing to Redis hashes. |
| `util/deserialize.js` | Converts JSON-stringified and boolean fields back to their native types after reading from Redis hashes. |
| `util/generateCdnUrl.js` | Constructs a CDN URL for a rendered view asset given a view name and content hash. Uses a three-level directory structure derived from the first four characters of the hash. |
| `util/updateCdnManifest.js` | Recomputes the CDN manifest for a template: renders each view that declares a `retrieve.cdn` target, hashes the output, stores the result on disk and in Redis, cleans up stale hashes, and writes the updated manifest into the template's metadata. Skips SITE-owned templates and templates not currently installed on their owner blog. |
| `util/forkSiteTemplate.js` | Creates a blog-owned copy of a SITE-owned template. If an existing fork already exists, it returns that fork's ID without duplicating. Handles name deduplication for repeated calls. |

### `tests/` subdirectory

Contains Mocha test files, one per exported function or feature. All tests use the shared setup in `tests/setup/index.js`, which provisions a test blog and optionally a test template and view via `beforeEach` hooks.

---

## Data Models

### Template metadata (`metadataModel.js`)

Stored as a Redis hash at key `template:{id}:info`.

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Stable identifier: `{owner}:{slug}`. |
| `name` | string | Display name, capped at 100 characters. |
| `slug` | string | URL-safe slug, capped at 30 characters. |
| `owner` | string | Blog ID or the literal string `"SITE"`. |
| `cloneFrom` | string | Template ID to clone views from at creation time. |
| `shareID` | string | UUID share token, or empty string when sharing is disabled. |
| `errors` | object | Map of view name to error message for views that failed to save. |
| `previewPath` | string | URL path used for template previewing. Defaults to `"/"`. |
| `isPublic` | boolean | Whether the template appears in the global public-template set. |
| `description` | string | Free-text description. |
| `localEditing` | boolean | Whether this template is managed from a folder on disk. |
| `thumb` | string | URL or path to a thumbnail image. |
| `locals` | object | Template-level custom locals injected into every view render. |
| `cdn` | object | Map of view name to content hash for CDN-cached rendered assets. |

Object and array fields are JSON-serialized before storage.

### View (`viewModel.js`)

Stored as a Redis hash at key `template:{id}:view:{viewName}`.

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | File name of the view (e.g. `"index.html"`). Cannot start with `.` or contain `/` or `\`. |
| `content` | string | Raw Mustache template content. Must be valid Mustache. Maximum serialized payload 2 MB. |
| `partials` | object | Map of partial name to inline partial content or `null` for template-view references. |
| `locals` | object | View-level locals merged with template-level locals at render time. |
| `retrieve` | object | Descriptor of data to fetch before rendering, computed by `parseTemplate`. Includes a `cdn` array of static asset targets. |
| `url` | string | Primary URL pattern for this view. |
| `urlPatterns` | array | Full list of URL patterns, including the primary. Stored separately at `template:{id}:url_patterns` as a Redis hash entry. |

---

## Public API

All functions below are exported from `index.js`. All callbacks follow the Node.js `(err, result)` convention unless noted.

### Template lifecycle

```js
create(owner, name, metadata, callback)
```
Creates a new template. `owner` is a blog ID or `"SITE"`. `name` is trimmed to 100 characters. A slug is derived from `name` if not supplied in `metadata`. Returns an error with `code: "EEXISTS"` if a template with the same derived ID already exists. If `metadata.cloneFrom` is set, all views are copied from the source template.

```js
update(owner, name, metadata, callback)
```
Updates an existing template's metadata by calling `setMetadata` after computing the template ID from `owner` and `name`.

```js
drop(owner, templateName, callback)
```
Deletes a template, all its views and URL mappings, its share token (if any), and all CDN-cached rendered output (both Redis entries and on-disk files). Bumps the owner blog's `cacheID`.

### Metadata

```js
getMetadata(id, callback)
```
Returns the deserialized metadata object for a template ID. Calls back with `err.code === "ENOENT"` when the template does not exist.

```js
setMetadata(id, updates, callback)
```
Merges `updates` into the existing metadata, writes to Redis, manages public-template set membership, bumps the blog's `cacheID` when changes are detected, and triggers `updateCdnManifest`.

### Views

```js
getView(templateID, viewID, callback)
```
Retrieves a view by exact name or by extension-less name. Returns an error if no match is found.

```js
setView(templateID, updates, callback)
```
Writes a view. Validates Mustache syntax, enforces the 2 MB size limit, normalizes URL patterns, runs infinite-partial-dependency detection, updates the URL-pattern hash, and triggers CDN manifest regeneration. Short-circuits without Redis writes when content and URL patterns are identical to the stored state.

```js
dropView(templateID, viewName, callback)
```
Removes a single view and its URL mapping from Redis. Bumps `cacheID` and triggers CDN manifest regeneration.

```js
getAllViews(name, callback)
```
Returns `(err, views, metadata)` where `views` is an object of all views keyed by name.

```js
getMultipleViews(templateName, viewNames, callback)
```
Fetches a named subset of views in parallel. Missing views are silently omitted.

```js
setMultipleViews(name, views, callback)
```
Writes multiple views in parallel. Used internally by `clone`.

```js
getFullView(blogID, templateID, viewName, callback)
```
Returns `(err, [locals, allPartials, retrieve, mimeType, content])` — the complete rendering payload for a view, with all partials resolved and retrieve descriptors merged across the partial tree.

```js
getPartials(blogID, templateID, partials, callback)
```
Resolves a partial map: partials starting with `/` are fetched as entry HTML from `models/entry`; others are fetched as named template views, recursively.

```js
getViewByURL(templateID, url, callback)
```
Returns `(err, viewName, params, query)`. First attempts pattern matching against stored URL patterns using `path-to-regexp`. Falls back to exact URL lookup. Returns `null` values for all results when no match exists.

### Template listing and sharing

```js
getTemplateList(blogID, callback)
```
Returns an array of metadata objects for all templates visible to `blogID`: those owned by `"SITE"` plus those owned by the blog itself.

```js
createShareID(templateID, callback)
```
Generates a UUID, stores it in the template's metadata, and creates a `template:share:{uuid}` Redis key mapping to the template ID. Returns the share token.

```js
dropShareID(shareID, callback)
```
Removes the share token from the template's metadata and deletes the Redis key.

```js
getByShareID(shareID, callback)
```
Looks up a template by its share token and returns the metadata.

### File-system synchronization

```js
buildFromFolder(blogID, callback)
```
Reads all template subdirectories under the blog's `templates/` or `Templates/` directory and calls `readFromFolder` for each. Drops locally-edited templates whose directories have been removed.

```js
readFromFolder(blogID, dir, callback)
```
Syncs a single on-disk template directory to Redis. Creates the template if absent, parses `package.json`, removes views for deleted files, and calls `setView` for each file. If `package.json` sets `enabled: true`, installs the template as the blog's active template.

```js
writeToFolder(blogID, templateID, callback)
```
Writes the template's views and generated `package.json` to the blog's file-system folder. Removes orphaned files. Requires that `blogID` is the owner of the template.

```js
removeFromFolder(blogID, templateID, callback)
```
Removes a locally-edited template's folder from the blog's file system. No-ops when `metadata.localEditing` is false.

```js
removeEnabledFromAllTemplates(blogID, callback)
```
Sets `enabled: false` in `package.json` for every template folder in the blog's directory. Writes updated metadata back to locally-edited templates.

### Utilities

```js
makeID(owner, name)  // → string
```
Derives a stable template ID by slugifying the name and joining with the owner: `"{owner}:{slug}"`.

```js
isOwner(owner, id, callback)  // → (err, isMember)
```
Returns `1` (truthy) if `id` is in the set of templates owned by `owner`, `0` otherwise.

```js
siteOwner  // === "SITE"
```
Constant string identifying the platform-level template owner.

```js
viewModel   // plain object: field → type string
metadataModel  // plain object: field → type string
```
Schema objects used by `helper/ensure` for runtime type validation and by `serialize`/`deserialize` for Redis round-trips.

```js
package  // { generate, save }
```
Converts between the Redis representation and the `package.json` file format used by locally-edited templates.

---

## Redis Key Structure

Defined in `key.js`:

| Key pattern | Type | Contents |
|-------------|------|----------|
| `template:{id}:info` | hash | Template metadata fields |
| `template:{id}:view:{viewName}` | hash | View fields |
| `template:{id}:all_views` | set | Names of all views belonging to the template |
| `template:{id}:url_patterns` | hash | `viewName → JSON-encoded urlPatterns array` |
| `template:{id}:url:{url}` | string | View name associated with a specific URL |
| `template:share:{shareID}` | string | Template ID associated with a share token |
| `template:public_templates` | set | IDs of all public (SITE) templates |
| `template:owned_by:{blogID}` | set | IDs of all templates owned by a blog |
| `cdn:rendered:{hash}` | string | Rendered and optionally minified asset content (Redis, kept for backward compatibility alongside on-disk storage) |

---

## CDN Asset Pipeline

Templates may declare CDN-managed static assets by referencing them inside `{{#cdn}}view-name{{/cdn}}` blocks in view content. `parseTemplate` extracts these target names into `view.retrieve.cdn`.

When a view or metadata is saved, `util/updateCdnManifest` runs:

1. Collects all CDN targets declared across every view of the template.
2. Skips execution for SITE-owned templates and templates not currently installed on the owner blog.
3. Renders each target view via `blog/render/view`.
4. Minifies CSS and JS outputs.
5. Computes a hash over `{templateID}:{viewName}:{renderedContent}`.
6. Stores the result both on disk under `{config.data_directory}/cdn/template/{h[0:2]}/{h[2:4]}/{h[4:]}/{basename}` and in Redis.
7. Purges stale CDN URLs for changed or removed targets.
8. Writes the updated `{target → hash}` manifest into `metadata.cdn`.

The CDN URL format is `{cdn.origin}/template/{h[0:2]}/{h[2:4]}/{h[4:]}/{basename}`.

---

## Internal Dependencies

| Module | Used for |
|--------|----------|
| `models/client` | Redis client (all reads and writes) |
| `models/blog` | Bumping `cacheID`, reading blog configuration, resolving the active client |
| `models/entry` | Fetching entry HTML for path-referenced partials in `getPartials` |
| `helper/ensure` | Runtime type and schema validation |
| `helper/makeSlug` | Slug generation for template IDs |
| `helper/localPath` | Resolving absolute paths in the blog's local file system |
| `helper/hash` | Content hashing for CDN manifest entries |
| `helper/minify` | CSS and JS minification for CDN assets |
| `helper/purgeCdnUrls` | Purging stale CDN cache entries |
| `helper/extend` | Shallow object merging |
| `helper/urlNormalizer` | Normalizing URL patterns before storage |
| `blog/render/view` | Rendering view content for CDN manifest computation |
| `blog/render/error` | Standardized error objects (e.g. infinite partial loop) |
| `blog/static/fonts` | Canonical font registry for `injectLocals` |
| `blog/static/syntax-highlighter` | Canonical syntax-highlighter theme registry for `injectLocals` |
| `clients` | File-system write/remove operations in `writeToFolder` and `removeFromFolder` |
| `clients/util/shouldIgnoreFile` | Filtering ignored files during folder sync |

### External packages

- `mustache` — template parsing and validation
- `path-to-regexp` — URL pattern matching in `getViewByURL`
- `uuid/v4` — share token generation
- `lodash` — deep clone in `serialize`/`deserialize`
- `fs-extra` — file-system operations
- `async` — series and parallel iteration

---

## Known Constraints

- View names cannot contain `/`, `\`, or start with `.`. Subdirectory structures within a template are not supported.
- Serialized view payloads are capped at 2 MB.
- Template names are truncated to 100 characters; derived slugs are truncated to 30 characters.
- `getMultipleViews` fetches views in parallel and silently discards errors for individual missing views.
- `setMultipleViews` also runs in parallel; if any view fails, the error from the last failure is reported.
- CDN manifest computation is skipped for SITE-owned templates. SITE templates do not participate in the CDN pipeline.
- CDN manifest is also skipped for templates not currently installed on their owner blog, and the existing manifest is cleared in that case.
- `readFromFolder` skips files larger than 2.5 MB.
- `injectLocals` mutates the `locals` object in-place and suppresses errors internally.

---

## Testing

Tests are located in `tests/`. Each file corresponds to one exported function. The shared setup module at `tests/setup/index.js` wires `beforeEach`/`afterEach` hooks using `global.test.templates()` and `global.test.blog()`.

To run the template model tests from the project root:

```
npm test -- --grep template
```

Individual test files may be run directly with the project's test runner if configured to do so.
