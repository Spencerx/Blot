# sync

The `sync` module is the entry point for all content processing in Blot. It provides an exclusive per-blog file-system lock and, within that lock, exposes a pipeline through which file changes are built into entries, stored in Redis, and reflected in the blog's public state.

Every sync client (Dropbox, Git, local) acquires the lock provided by this module before modifying a blog's folder or calling `folder.update`. This ensures that no two processes concurrently modify or process the same blog folder.

## Structure

```
sync/
  index.js                  Primary export. Acquires the folder lock and yields the
                            folder interface to the caller.
  rebuild.js                Full-folder rebuild: walks every file in the blog directory
                            and calls update on each path in series.
  renames.js                Post-sync rename detection. Correlates recently created and
                            deleted entries by file size and title to infer moves.
  messenger.js              Factory for the log/status/syncID triple attached to every
                            sync session.
  establishSyncLock.js      Promise-based wrapper around index.js for async/await callers.
  lock-diagnostics.js       Gathers system-state diagnostics (disk, CPU, memory, lock
                            file stats) when the proper-lockfile lock is compromised.
  lock-diagnostics-state.js In-process registry of active sync IDs and in-flight
                            file-update paths. Consulted by lock-diagnostics.js.

  update/
    index.js                Constructs the update(path, callback) function bound to a
                            blog. Dispatches to set or drop based on whether the file
                            exists. Detects file changes mid-update and re-runs.
    set.js                  Handles an existing file: classifies it as public, template,
                            preview, or post/page; builds and stores the entry; triggers
                            dependent rebuilds.
    drop.js                 Handles a removed file: drops the entry and any ignored-file
                            record; removes the draft preview file; triggers dependent
                            rebuilds.
    ignore.js               Records a path in the ignoredFiles model and drops any
                            existing entry for that path.
    rebuildDependents.js    Rebuilds all entries that declared a dependency on the
                            changed path. Reads the dependency set from Redis and calls
                            build + Entry.set for each dependent.
    drafts.js               Classifies a path as a draft, a preview file, or neither.
                            Computes preview file paths. Exposes route constants used by
                            the dashboard SSE stream.
    preview/
      index.js              Re-exports write and remove.
      write.js              Writes a preview HTML wrapper to the blog folder (via the
                            sync client or directly to disk for client-less blogs).
      remove.js             Removes the preview HTML file from the blog folder via the
                            sync client.
      injection.html        Mustache template for the SSE script tag injected into
                            draft preview pages.
      wrapper.html          Mustache template for the outer iframe shell that hosts
                            a draft preview.
      readme.txt            Design notes for the draft preview feature.

  fix/
    index.js                Orchestrator: runs all five repair routines in series against
                            a blog, then bumps cacheID if any routine reported changes.
    entry-ghosts.js         Detects entries whose stored path does not match the actual
                            file on disk (case mismatch or missing file). Corrects the
                            path or drops the entry.
    list-ghosts.js          Removes stale entry IDs from the six Redis sorted sets
                            (all, created, entries, drafts, scheduled, pages).
    tag-ghosts.js           Removes empty tags and stale entry IDs from tag sorted sets.
    menu-ghosts.js          Removes deleted or duplicate entries from the blog menu array
                            and updates stale labels, URLs, and metadata.
    entries-path-index.js   Compares the entry count to the lex path-index count and
                            calls pathIndex.backfillIndex when they diverge.
    tests/
      entries-path-index.js Unit tests for entries-path-index.js using Jasmine spies.

  tests/
    index.js                Tests for lock acquisition, mutual exclusion, stale-lock
                            recovery after process death, and sequential re-sync.
    build.js                Integration tests for the full update pipeline: path
                            normalisation, ignored files, dependent rebuilds, slug/link
                            metadata.
    update.js               Integration tests for the update function: create, delete,
                            mid-update file-change re-run.
    renames.js              Integration tests for rename detection across single and
                            multiple syncs, empty files, draft-to-post moves, and ghost
                            entries.
    rebuild.js              Integration tests for the full-folder rebuild, including
                            cache-wipe options.
    multiple.js             Tests that stale locks from a killed child process are
                            released across 20 concurrent blogs.
    error.js                Child process used by index.js tests to simulate a crash.
    kill.js                 Child process used to simulate a SIGKILL during a sync.
```

## Public API

### `sync(blogID, callback)`

**File:** `index.js`

Acquires a filesystem lock on the blog's folder using `proper-lockfile`, then calls `callback(err, folder, done)`.

- `blogID` — string. Throws `TypeError` if not a string.
- `callback(err, folder, done)` — called once the lock is acquired or on failure.
  - `err` — non-null if the blog cannot be found, is disabled, or the lock could not be acquired.
  - `folder.path` — absolute path to the blog's local folder (trailing slash stripped).
  - `folder.update(path, callback)` — processes a single path. See `update/index.js`.
  - `folder.status(message)` — broadcasts a status message via Redis pub/sub.
  - `folder.log(...args)` — writes a prefixed log line to stdout.
  - `done(syncError, callback)` — releases the lock. Must be called exactly once. Internally runs `renames`, `buildFromFolder` (templates), and bumps `blog.cacheID` when at least one `folder.update` was called.

**Lock configuration:**
- Stale timeout: 10 seconds.
- Update heartbeat interval: 3 seconds.
- Retry strategy at process startup (within 10s): 1 retry with an 11-second minimum timeout, to handle stale locks from recently killed processes.
- Retry strategy after startup: 3 retries at 750ms, 1.5s, 3s.

### `rebuild(blogID, [options], callback)`

**File:** `rebuild.js`

Walks every file in the blog's local folder and calls `update(path, ...)` on each in series. Does not acquire the sync lock; intended to be called by the caller's own sync session or an administrative tool.

- `options.thumbnails` — boolean. Flushes the thumbnail Transformer store and empties the `_thumbnails` static directory before rebuilding.
- `options.imageCache` — boolean. Flushes the image-cache Transformer store and empties the `_image_cache` static directory before rebuilding.

### `establishSyncLock(blogID)`

**File:** `establishSyncLock.js`

Promise-based wrapper. Resolves to `{ folder, done }` where `folder.update` is promisified and `done` is an async function. Used by async/await callers.

## Internal Modules

### `update/index.js`

Returns a closure `update(path, callback)` bound to a `blog` object, a `log` function, and a `status` function.

**Dispatch logic:**

1. Hashes the file before processing (`hashBefore`).
2. `fs.stat` the file:
   - `ENOENT` → calls `drop(blogID, path, ...)`.
   - `isDirectory` → calls `maybeEnableInjectTitle` (auto-enables the `injectTitle` plugin when a `.obsidian` directory is detected, unless already enabled or explicitly disabled).
   - Otherwise → calls `set(blog, path, ...)`.
3. After the operation, hashes the file again (`hashAfter`). If the hash changed during processing, the update is retried recursively.
4. Flushes the blog cache after each file.

### `update/set.js`

Classifies the path and routes it:

- **Public file** (path starts with `/public/`, contains `/_`, `/.`, or `.textbundle/assets/`): records it in the `ignoredFiles` model.
- **Template file** (path starts with `/templates/`): no entry action taken.
- **Preview file** (identified by `drafts.isPreview`): no entry action taken.
- **Post/page**: calls `build(blog, path, ...)` then `Entry.set`. After setting, triggers `rebuildDependents` for wikilink slug and filename synthetic keys. If the entry is a visible draft, writes a preview file.
- Always calls `rebuildDependents(blogID, path, ...)` for the raw path after the above.

### `update/drop.js`

Runs in series: `Ignored.drop` → `Entry.drop` → `rebuildDependents`. If the path is currently a draft, also calls `Preview.remove`.

### `update/rebuildDependents.js`

Reads the Redis set at `Entry.key.dependents(blogID, path)`. For each dependent path, retrieves the entry, calls `build`, and calls `Entry.set(..., false)` (the `false` suppresses scheduled-post side effects).

### `update/drafts.js`

An IIFE exposing:

| Export | Description |
|---|---|
| `isDraft(blogID, path, cb)` | `true` if the filename has a `[draft]` prefix or the path is inside `/drafts/` (and is not itself a preview). |
| `isPreview(blogID, path, cb)` | `true` if the file ends in `.preview.html`, starts with `[preview]`, or contains `<meta data-blot-document="preview-container"/>`. |
| `previewPath(filePath)` | Returns the expected path of the preview file for a given draft path. |
| `previewFile(handle, path, cb)` | Renders the preview wrapper HTML for a draft at `path`. |
| `viewURL(handle, filePath)` | Constructs the full URL for a draft preview. |
| `injectScript(html, filePath, cb)` | Inserts the SSE stream script tag into the `<head>` of a rendered page. |
| `viewRoute` | Route pattern: `/draft/view/*` |
| `streamRoute` | Route pattern: `/draft/stream/*` |

Draft detection rules:
- Filename prefixed with `[draft]` → always a draft.
- Path is outside `/drafts/` → never a draft.
- Path is inside `/drafts/` and is not a preview → draft.

### `messenger.js`

Called once per sync with the `blog` object. Returns `{ log, status, syncID }`.

- `syncID` — a UUID prefix of the form `sync_XXXXXXX`, unique per sync session.
- `log(...args)` — prefixes each line with timestamp, truncated blog ID, syncID, and client name, then writes to stdout.
- `status(message)` — calls `Blog.setStatus`, calls `log`, and publishes to the Redis channel `sync:status:{blogID}`.

### `lock-diagnostics-state.js`

In-process state tracking using two `Map` structures. Exported functions:

| Function | Description |
|---|---|
| `addPendingSync(blogID, syncID)` | Records a sync session as active. |
| `removePendingSync(blogID, syncID)` | Removes the session and all its pending updates. |
| `addPendingUpdate(blogID, syncID, filePath)` | Records a file path as currently being processed. |
| `removePendingUpdate(blogID, syncID, filePath)` | Removes a file from the in-flight set. |
| `getPendingSyncs()` | Returns an array of `{ blogID, syncID }` for all active sessions. |
| `getPendingUpdates()` | Returns an array of `{ blogID, syncID, filePath }` for all in-flight updates. |

### `lock-diagnostics.js`

`gatherLockDiagnostics({ blogID, lockPath, lockAcquiredAt, syncContext, timeoutMs })` → `Promise<object>`

Called by `index.js` when `proper-lockfile` fires the `onCompromised` handler. Collects and returns a diagnostics object containing: pending syncs and updates, process PID and memory, OS load averages, disk space, and `stat` results for the lock file and lock directory. Each field is gathered with a shared deadline (default 2 seconds) so diagnostics cannot block indefinitely.

### `renames.js`

Called at the end of every sync, inside `done(...)`. Looks back 30 seconds to find entries created and entries deleted in that window.

Rename heuristic:
1. Match a deleted entry with a created entry that has the same non-zero `size`. If exactly one match, treat it as a rename.
2. If no size match, match by identical `title`. If exactly one match, treat it as a rename.

For each matched rename:
- Transfers `url` and `guid` from the deleted entry to the created entry.
- Transfers `dateStamp` when neither entry had a date specified in its filename or metadata.
- Transfers `created` timestamp unless the deleted entry was in a draft state.
- Clears the `guid` on the deleted entry so it cannot be matched again.

### `fix/index.js`

`fix(blog, callback)` — runs five repair routines in series:

1. `entryGhosts` — resolves path case mismatches; drops entries whose files are missing.
2. `tagGhosts` — prunes empty tags and stale tag-member IDs.
3. `listGhosts` — prunes stale IDs from the six entry sorted sets.
4. `menuGhosts` — removes deleted/duplicate entries from `blog.menu`; updates stale labels, URLs, and metadata.
5. `entriesPathIndex` — backfills the `entries:lex` sorted set if its count diverges from the `entries` sorted set.

If any routine produced a non-empty report, bumps `blog.cacheID` to force cache invalidation. Returns `(err, finalReport)` where `finalReport` is an object keyed by function name.

## Sync Pipeline

A complete sync session follows this sequence:

```
sync(blogID, cb)
  └─ Blog.get                        Verify blog exists and is not disabled
  └─ messenger(blog)                 Create log/status/syncID
  └─ lockfile.lock(blogPath)         Acquire filesystem lock
  └─ callback(null, folder, done)    Yield control to caller
       └─ folder.update(path, ...)   [zero or more times]
            └─ hashFile (before)
            └─ fs.stat
                 ├─ ENOENT → drop
                 ├─ directory → maybeEnableInjectTitle
                 └─ file → set
                      ├─ isPreview / isPublic / isTemplate classification
                      ├─ build(blog, path)
                      ├─ Entry.set
                      ├─ rebuildDependents (wikilink keys)
                      └─ Preview.write (if visible draft)
            └─ hashFile (after) → retry if changed
            └─ flushCache
  └─ done(syncError, finalCallback)
       └─ renames(blogID)            Detect file moves by size/title correlation
       └─ buildFromFolder(blogID)    Rebuild templates from Templates/ folder
       └─ lockfile.unlock
       └─ Blog.set({ cacheID })      Only if folder.update was called at least once
       └─ finalCallback(syncError)
```

## Integration Points

| Dependency | Role |
|---|---|
| `models/blog` | Fetches blog configuration; sets `cacheID` and status. |
| `models/entry` | `Entry.set` / `Entry.drop` — core entry persistence. |
| `models/entries` | `getCreated` / `getDeleted` — used by `renames.js`. |
| `models/template` | `buildFromFolder` — rebuilds templates at end of sync. |
| `models/ignoredFiles` | Records paths excluded from entry processing. |
| `models/client` (Redis) | Publishes `sync:status:{blogID}` messages; reads dependency sets. |
| `build` | Converts a file at a path into an entry object. |
| `helper/localPath` | Resolves blog-relative paths to absolute paths on disk. |
| `helper/hashFile` | Detects mid-update file changes. |
| `helper/pathNormalizer` | Normalises path separators and casing before dispatch. |
| `proper-lockfile` | Provides the filesystem-level mutual exclusion lock. |
| `clients/*` | Dropbox, Git, and local clients all call `sync(blogID, ...)` to acquire the lock before processing their change lists. |

## Known Constraints

- The lock is per-process and file-system based (`proper-lockfile`). It does not coordinate across machines; running multiple application servers against the same blog folder without shared storage will not be safe.
- `renames.js` relies on a 30-second window and a heuristic match by file size or title. Renames involving empty files are skipped (zero `size` is excluded). Ambiguous renames — where multiple deleted entries have the same size or title — are not resolved.
- `rebuildDependents` suppresses build errors for individual dependents and continues, so a broken dependent entry does not block other rebuilds.
- `rebuild.js` does not acquire the sync lock itself; callers are responsible for ensuring no concurrent sync is in progress.
- The `maybeEnableInjectTitle` side effect in `update/index.js` mutates `blog.plugins` in-place on the in-memory blog object, so subsequent updates within the same sync session see the updated plugin state.

## Tests

Tests use Jasmine and the shared `global.test.blog()` / `global.test.blogs(n)` helpers to provision test blogs with a local folder.

```
# From the repository root
npx jasmine app/sync/tests/index.js
npx jasmine app/sync/tests/build.js
npx jasmine app/sync/tests/update.js
npx jasmine app/sync/tests/renames.js
npx jasmine app/sync/tests/rebuild.js
npx jasmine app/sync/tests/multiple.js
npx jasmine app/sync/fix/tests/entries-path-index.js
```

The lock-release tests (`index.js`, `multiple.js`) fork child processes (`tests/error.js`, `tests/kill.js`) to simulate crashes and SIGKILL, then verify the parent can re-acquire the lock.
